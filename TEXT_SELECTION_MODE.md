# API 溯源工具 - 文本选取模式

## 🎯 新功能：手动选取文本查找来源

### 问题场景
在某些情况下，自动提取元素内的文本不够精确：
- 容器内包含多个数据，难以确定具体是哪个
- 数字格式化后（千分位、货币符号）难以匹配
- 需要精确选择某个特定的数字或文本

### 解决方案：文本选取模式

用户可以通过**拖动鼠标选择**页面上的任意文本或数字，然后点击浮动按钮查找其在 API 中的来源。

---

## 🚀 使用方法

### 方法一：启动检查器（原有功能）
1. 点击扩展图标
2. 切换到 "🔍 API溯源" 工具
3. 点击 "🎯 启动检查器"
4. 鼠标悬停或点击页面元素

**适用场景**：快速查看整个元素的数据来源

### 方法二：选取文本（新功能）✨
1. **不需要启动检查器**
2. 在页面上拖动鼠标，选择你想查找的文本或数字
3. 松开鼠标后，会出现一个浮动按钮 "🔍 查找来源"
4. 点击浮动按钮，查看该文本在 API 中的来源

**适用场景**：精确查找某个特定数字或文本的来源

---

## 📊 功能特性

### 1. 智能格式化
自动处理多种数字格式：

| 原始文本 | 格式化结果 |
|---------|-----------|
| `1,234,567` | `1234567` |
| `$1,234.56` | `1234.56`, `123456` |
| `€1.234,56` | `1234.56` |
| `12.5%` | `12.5`, `125` |
| `+1,234.56` | `1234.56` |

**格式化策略**：
1. 原始文本（完全匹配）
2. 去除千分位逗号
3. 去除货币符号和空格
4. 只保留数字和小数点
5. 只保留纯数字

### 2. 浮动按钮
- **位置**：鼠标选取位置附近（右下方偏移 10px）
- **样式**：渐变紫色背景，悬停放大效果
- **交互**：点击搜索，点击其他地方自动隐藏

### 3. 搜索结果
- **找到来源**：显示详细的 API 信息面板
  - API URL
  - 请求方法和状态码
  - 匹配的字段
  - 响应时间
- **未找到**：显示友好的提示面板
  - 显示选中的文本
  - 可能的原因说明

---

## 🎬 使用示例

### 示例 1：查找订单金额

**页面显示**：
```
订单总金额: $1,234.56
```

**操作**：
1. 拖动鼠标选择 `$1,234.56`
2. 点击浮动按钮 "🔍 查找来源"

**搜索过程**：
```javascript
原始文本: "$1,234.56"
格式化为:
  - "$1,234.56"     // 原始
  - "1234.56"       // 去逗号
  - "1234.56"       // 去货币符号
  - "1234.56"       // 只数字和点
  - "123456"        // 纯数字
```

**结果**：
```
✅ 找到 1 个数据来源
POST 200 52ms
https://xxx.com/api_mart/order/detail
匹配文本: 1234.56, 123456
```

### 示例 2：查找司机数量

**页面显示**：
```
今日活跃司机: 1,234 人
```

**操作**：
1. 拖动鼠标只选择数字 `1,234`
2. 点击 "🔍 查找来源"

**搜索过程**：
```javascript
原始文本: "1,234"
格式化为:
  - "1,234"    // 原始
  - "1234"     // 去逗号
  - "1234"     // 去符号
```

**结果**：
```
✅ 找到 1 个数据来源
GET 200 28ms
https://xxx.com/api_mart/driver/stats
匹配文本: 1234
```

### 示例 3：查找百分比

**页面显示**：
```
完成率: 98.5%
```

**操作**：
1. 选择 `98.5%`
2. 点击 "🔍 查找来源"

**搜索过程**：
```javascript
原始文本: "98.5%"
格式化为:
  - "98.5%"   // 原始
  - "98.5"    // 去百分号
  - "985"     // 纯数字
```

**结果**：
```
✅ 找到 1 个数据来源
POST 200 35ms
https://xxx.com/api_mart/station/completion
匹配文本: 98.5, 985
```

---

## 🔧 技术实现

### 1. 文本选取监听
```javascript
document.addEventListener('mouseup', (e) => {
  const selection = window.getSelection();
  const selectedText = selection.toString().trim();
  
  if (selectedText) {
    this.showSelectionFloatingBtn(e.clientX, e.clientY);
  }
});
```

### 2. 格式化逻辑
```javascript
normalizeSelectedText(text) {
  const normalized = [];
  
  // 1. 原始文本
  normalized.push(text);
  
  // 2. 去除千分位
  normalized.push(text.replace(/,/g, ''));
  
  // 3. 去除货币符号
  normalized.push(text.replace(/[$€¥₹£\s,]/g, ''));
  
  // 4. 只保留数字和小数点
  normalized.push(text.replace(/[^0-9.]/g, ''));
  
  // 5. 只保留纯数字
  normalized.push(text.replace(/[^0-9]/g, ''));
  
  return [...new Set(normalized)]; // 去重
}
```

### 3. 浮动按钮渲染
```javascript
showSelectionFloatingBtn(x, y) {
  const btn = document.createElement('div');
  btn.style.cssText = `
    position: fixed;
    top: ${y + 10}px;
    left: ${x + 10}px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    /* ... 其他样式 */
  `;
  btn.innerHTML = `
    <span>🔍</span>
    <span>查找来源</span>
  `;
  document.body.appendChild(btn);
}
```

### 4. 与检查器模式的协调
```javascript
// 如果检查器模式开启，不处理文本选取
if (this.inspectorMode) return;
```

避免两种模式冲突。

---

## 🎨 UI 设计

### 浮动按钮样式
```css
.spx-selection-floating-btn {
  position: fixed;
  background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
  color: white;
  padding: 8px 15px;
  border-radius: 20px;
  font-size: 12px;
  cursor: pointer;
  box-shadow: 0 4px 12px rgba(0,0,0,0.3);
  transition: all 0.2s;
}

.spx-selection-floating-btn:hover {
  transform: scale(1.05);
  box-shadow: 0 6px 16px rgba(0,0,0,0.4);
}
```

### "未找到来源"面板
```
┌─────────────────────────────┐
│         🔍                  │
│   未找到数据来源            │
│                             │
│ 选中的文本: $1,234.56      │
│                             │
│ 可能原因：                  │
│ 1. API 响应中不包含此数据   │
│ 2. 数据格式不匹配           │
│ 3. 未捕获到 API 请求        │
│                             │
│      [ 知道了 ]            │
└─────────────────────────────┘
```

---

## 🐛 调试方法

### 查看格式化结果
打开 Console：
```javascript
// 选择文本后，查看格式化结果
// Console 会输出：
📝 [SPX Helper] 用户选取文本: $1,234.56
📝 [SPX Helper] 格式化后的文本: ["$1,234.56", "1234.56", "123456"]
```

### 查看搜索过程
```javascript
🔎 [SPX Helper] 开始搜索选中文本: $1,234.56
   🔍 检查 API: https://xxx.com/api_mart/order/detail
      → 尝试匹配文本: "$1,234.56"
         匹配结果: false
      → 尝试匹配文本: "1234.56"
         ✅ [策略2-标准化] 匹配成功
   ✅ 找到匹配: https://xxx.com/api_mart/order/detail 匹配文本: ["1234.56"]
   📊 总共找到 1 个数据来源
```

### 清除浮动按钮
如果浮动按钮卡住不消失：
```javascript
document.getElementById('spx-selection-floating-btn')?.remove();
```

---

## 💡 使用技巧

### 1. 精确选择
只选择你想查找的部分，不要包含多余文本：

❌ **不好**：选择 `订单金额: $1,234.56`  
✅ **好**：只选择 `$1,234.56`

### 2. 数字格式
支持各种常见格式，不需要手动去除符号：

✅ `$1,234.56` → 自动格式化  
✅ `€1.234,56` → 自动处理欧洲格式  
✅ `12.5%` → 自动去除百分号

### 3. 组合使用
两种模式可以互补使用：

- **检查器模式**：快速查看整个区域
- **文本选取**：精确查找某个数字

### 4. 快速重试
如果第一次没找到，可以：
1. 刷新页面（让扩展重新捕获 API）
2. 重新选择文本
3. 尝试选择不同格式（如去掉货币符号）

---

## 📈 对比两种模式

| 特性 | 检查器模式 | 文本选取模式 ✨ |
|------|-----------|----------------|
| **触发方式** | 点击"启动检查器" | 直接拖动选择 |
| **精确度** | 整个元素 | 精确到选中文本 |
| **格式化** | 基本格式化 | 智能多级格式化 |
| **使用场景** | 快速探索 | 精确查找 |
| **冲突处理** | 独占模式 | 与页面不冲突 |
| **适合对象** | 开发调试 | 日常使用 |

---

## 🎯 总结

文本选取模式让 API 溯源工具更加灵活和精确：

✅ **更精确**：用户可以选择具体要查找的内容  
✅ **更简单**：不需要启动检查器，直接选择即可  
✅ **更智能**：自动处理各种数字格式  
✅ **更友好**：浮动按钮 + 友好的提示面板

现在，查找页面数据来源就像使用 Google 翻译一样简单！
