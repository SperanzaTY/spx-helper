# ğŸ‰ API æ‹¦æˆªå™¨ v2 - ä½¿ç”¨ MAIN World

## âœ… è§£å†³æ–¹æ¡ˆ

### é—®é¢˜
- CSP (Content Security Policy) é˜»æ­¢äº†å†…è”è„šæœ¬æ³¨å…¥
- Content Script å’Œé¡µé¢è¿è¡Œåœ¨ä¸åŒçš„ JavaScript ä¸Šä¸‹æ–‡

### è§£å†³æ–¹æ¡ˆ
ä½¿ç”¨ Manifest V3 çš„ `world: "MAIN"` ç‰¹æ€§ï¼š
- `injected.js` è¿è¡Œåœ¨**é¡µé¢ä¸Šä¸‹æ–‡** (MAIN world)
- `content.js` è¿è¡Œåœ¨**éš”ç¦»ä¸Šä¸‹æ–‡** (ISOLATED world)
- ä¸¤è€…é€šè¿‡ `postMessage` é€šä¿¡

---

## ğŸ“ æ–‡ä»¶ç»“æ„

### 1. `manifest.json`
```json
"content_scripts": [
  {
    "matches": ["<all_urls>"],
    "js": ["injected.js"],
    "run_at": "document_start",
    "world": "MAIN"  â† å…³é”®ï¼šåœ¨é¡µé¢ä¸Šä¸‹æ–‡è¿è¡Œ
  },
  {
    "matches": ["<all_urls>"],
    "js": ["content.js"],
    "run_at": "document_start"
  }
]
```

### 2. `injected.js` (NEW)
- è¿è¡Œåœ¨é¡µé¢ä¸Šä¸‹æ–‡
- æ‹¦æˆª `window.fetch` å’Œ `XMLHttpRequest`
- è®°å½•åˆ° `window.__spxAPIRecords`
- é€šè¿‡ `postMessage` é€šçŸ¥ content script

### 3. `content.js` (UPDATED)
- è¿è¡Œåœ¨éš”ç¦»ä¸Šä¸‹æ–‡
- ç›‘å¬ `postMessage` æ¥æ”¶ API è®°å½•
- ç®¡ç† UIï¼ˆæ£€æŸ¥å™¨ã€æç¤ºæ¡†ã€é¢æ¿ï¼‰
- ä¸ popup é€šä¿¡

---

## ğŸ§ª æµ‹è¯•æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šé‡æ–°åŠ è½½æ‰©å±•
```
chrome://extensions/ â†’ SPX Helper â†’ ğŸ”„ é‡æ–°åŠ è½½
```

### ç¬¬ 2 æ­¥ï¼šåˆ·æ–°é¡µé¢
```
F5ï¼ˆæˆ– Ctrl+Shift+R ç¡¬åˆ·æ–°ï¼‰
```

### ç¬¬ 3 æ­¥ï¼šæŸ¥çœ‹ Console

**é¢„æœŸè¾“å‡º**ï¼š
```
ğŸ” [SPX Helper] æ‹¦æˆªå™¨è„šæœ¬å·²åŠ è½½ï¼ˆé¡µé¢ä¸Šä¸‹æ–‡ï¼‰
âœ… [SPX Helper] API æ‹¦æˆªå™¨å·²å®‰è£…åœ¨é¡µé¢ä¸Šä¸‹æ–‡
ğŸ” [SPX Helper] Content Script å·²åŠ è½½
âœ… [SPX Helper] Content Script å·²å°±ç»ª

ï¼ˆé¡µé¢åŠ è½½ï¼Œå‘é€è¯·æ±‚ï¼‰

ğŸš€ [SPX Helper] æ‹¦æˆªåˆ° Fetch: https://api.example.com/stations
ğŸ“¡ [SPX Helper] Fetch è®°å½•æˆåŠŸ: https://api.example.com/stations æ€»æ•°: 1

ğŸš€ [SPX Helper] æ‹¦æˆªåˆ° XHR: POST https://api.example.com/user
ğŸ“¡ [SPX Helper] XHR è®°å½•æˆåŠŸ: https://api.example.com/user æ€»æ•°: 2
```

### ç¬¬ 4 æ­¥ï¼šæ‰‹åŠ¨æµ‹è¯•

åœ¨ Console ä¸­è¿è¡Œï¼š

```javascript
fetch('https://httpbin.org/get')
  .then(r => r.json())
  .then(data => console.log('æµ‹è¯•æˆåŠŸ:', data));
```

**åº”è¯¥çœ‹åˆ°**ï¼š
```
ğŸš€ [SPX Helper] æ‹¦æˆªåˆ° Fetch: https://httpbin.org/get
ğŸ“¡ [SPX Helper] Fetch è®°å½•æˆåŠŸ: https://httpbin.org/get æ€»æ•°: 3
æµ‹è¯•æˆåŠŸ: {args: {}, ...}
```

### ç¬¬ 5 æ­¥ï¼šæ£€æŸ¥ API æ•°é‡

æ‰“å¼€æ‰©å±•çª—å£ â†’ å®ç”¨å·¥å…· â†’ APIæº¯æº

**åº”è¯¥çœ‹åˆ°**ï¼š
```
å·²æ•è· API: 3 ä¸ª
```

### ç¬¬ 6 æ­¥ï¼šéªŒè¯é¡µé¢ä¸Šä¸‹æ–‡

åœ¨ Console ä¸­è¿è¡Œï¼š

```javascript
// åº”è¯¥èƒ½è®¿é—®
window.__spxAPIRecords.size  // â†’ 3

// æŸ¥çœ‹æ‰€æœ‰ API
window.__spxAPIRecords.forEach((record, id) => {
  console.log(record.method, record.url);
});
```

---

## ğŸ¯ å…³é”®åŒºåˆ«

### æ—§æ–¹æ¡ˆï¼ˆå¤±è´¥ï¼‰
```javascript
// content.js ä¸­æ³¨å…¥è„šæœ¬
const script = document.createElement('script');
script.textContent = '...';
document.head.appendChild(script);
// âŒ è¢« CSP é˜»æ­¢
```

### æ–°æ–¹æ¡ˆï¼ˆæˆåŠŸï¼‰
```json
// manifest.json
{
  "js": ["injected.js"],
  "world": "MAIN"  â† ç›´æ¥è¿è¡Œåœ¨é¡µé¢ä¸Šä¸‹æ–‡
}
// âœ… ä¸å— CSP é™åˆ¶
```

---

## ğŸ“Š æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚          Page Context (MAIN)        â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      injected.js              â”‚  â”‚
â”‚  â”‚  - æ‹¦æˆª fetch/XHR             â”‚  â”‚
â”‚  â”‚  - è®°å½•åˆ° __spxAPIRecords     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚              â”‚ postMessage          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
               â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     Content Script (ISOLATED)       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚      content.js               â”‚  â”‚
â”‚  â”‚  - æ¥æ”¶ API è®°å½•              â”‚  â”‚
â”‚  â”‚  - ç®¡ç† UI                    â”‚  â”‚
â”‚  â”‚  - ä¸ popup é€šä¿¡              â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸš€ ä¼˜åŠ¿

1. **ç»•è¿‡ CSP** - ä¸ä½¿ç”¨å†…è”è„šæœ¬
2. **å¯é æ‹¦æˆª** - åœ¨é¡µé¢æœ€æ—©æ—¶æœºè¿è¡Œ
3. **å®Œæ•´è®¿é—®** - å¯ä»¥è®¿é—®é¡µé¢çš„çœŸå® window å¯¹è±¡
4. **æ•°æ®å…±äº«** - é€šè¿‡ postMessage é€šä¿¡

---

**ç°åœ¨æµ‹è¯•å¹¶å‘Šè¯‰æˆ‘ç»“æœï¼** ğŸ”

å¦‚æœè¿˜æœ‰é—®é¢˜ï¼Œè¯·æä¾›å®Œæ•´çš„ Console è¾“å‡ºã€‚
